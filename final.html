<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Interactive Map with Bar Chart and Pop Up</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
<link href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>
<script src="https://d3js.org/d3.v7.min.js"></script>
<style>
body { margin: 0; padding: 0; }
#map { position: absolute; top: 0; bottom: 50%; width: 100%; }
.map-content { position: absolute; top: 50%; bottom: 0; width: 100%; overflow-y: auto; padding: 20px; background-color: white; }
.mapboxgl-popup {
    max-width: 400px;
    font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
}
#d3-container {
    position: absolute;
    top: 50%;
    left: 0;
    width: 100%;
    height: 50%;
    background: #fff;
    overflow-y: auto;
}
</style>
</head>
<body>
<div id="map"></div>
<div class="map-content">
    <h1> About the Project </h1>
    <h2> Credits Through Dynamic Map </h2>
    <div id='d3-container'></div>
</div>
<script>
mapboxgl.accessToken = 'pk.eyJ1IjoiaGlsbGFyeWNoYW5nIiwiYSI6ImNsdzB0bTUwcTA0bDcyaXFjaDEzZGduMXUifQ.PwESlw8F78LN1gE7GjuyMg';
const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v12',
    center: [-100.04, 38.907],
    zoom: 3
});

map.on('load', () => {
    map.addSource('states', {
        'type': 'geojson',
        'data': 'https://andreathecheatcode.github.io/DSC106-Proj03/credit_state.geojson'
    });

    map.addLayer({
        'id': 'states-layer',
        'type': 'fill',
        'source': 'states',
        'paint': {
            'fill-color': 'rgba(0, 0, 0, 0.5)',
            'fill-outline-color': 'rgba(0, 0, 0, 0.5)'
        }
    });

    map.on('click', 'states-layer', (e) => {
        const properties = e.features[0].properties;
        let years = properties.year;
        let creds = properties.creds;

        if (typeof years === 'string') {
            years = JSON.parse(years);
        }
        if (typeof creds === 'string') {
            creds = JSON.parse(creds);
        }

        let content = `<strong>${properties.name}</strong><br>`;

        if (Array.isArray(years) && Array.isArray(creds) && years.length === creds.length) {
            for (let i = 0; i < years.length; i++) {
                content += `Year ${years[i]}: ${creds[i]} creds<br>`;
            }
            drawBarChart(years.map((year, index) => ({ name: year.toString(), creds: creds[index] })));
        } else {
            content += "Data format error or missing data.";
        }

        new mapboxgl.Popup()
            .setLngLat(e.lngLat)
            .setHTML(content)
            .addTo(map);
    });
});

function drawBarChart(data) {
    d3.select("#d3-container").select("svg").remove();

    const margin = { top: 20, right: 20, bottom: 40, left: 40 },
        width = 480 - margin.left - margin.right,
        height = 300 - margin.top - margin.bottom;

    const svg = d3.select("#d3-container").append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform",
            "translate(" + margin.left + "," + margin.top + ")");

    const x = d3.scaleBand()
        .range([0, width])
        .padding(0.1)
        .domain(data.map(d => d.name));

    const y = d3.scaleLinear()
        .domain([0, d3.max(data, d => d.creds)])
        .range([height, 0]);

    svg.append("g")
        .attr("transform", "translate(0," + height + ")")
        .call(d3.axisBottom(x))
        .selectAll("text")
        .style("text-anchor", "end")
        .attr("dx", "-.8em")
        .attr("dy", ".15em")
        .attr("transform", "rotate(-45)");

    svg.append("g")
        .call(d3.axisLeft(y));

    svg.selectAll(".bar")
        .data(data)
        .enter().append("rect")
        .attr("class", "bar")
        .attr("x", d => x(d.name))
        .attr("width", x.bandwidth())
        .attr("y", d => y(d.creds))
        .attr("height", d => height - y(d.creds))
        .attr("fill", "#007BFF");
}

</script>
</body>
</html>

